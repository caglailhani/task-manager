name: CD - Task Manager (Kubernetes deploy)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted   # Senin bilgisayarÄ±ndaki runner

    env:
      DOCKERHUB_USERNAME: ilhanicagla

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show kubectl context
        run: kubectl config current-context

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/mysql/
          kubectl apply -f k8s/backend/
          kubectl apply -f k8s/frontend/

      - name: Update backend image
        run: |
          kubectl set image deployment/backend backend=docker.io/${{ env.DOCKERHUB_USERNAME }}/task-backend:latest
          kubectl rollout status deployment/backend

      - name: Update frontend image
        run: |
          kubectl set image deployment/frontend frontend=docker.io/${{ env.DOCKERHUB_USERNAME }}/task-frontend:latest
          kubectl rollout status deployment/frontend
